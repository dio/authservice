# Increasing reproducibility. Reference: https://bazel.build/reference/command-line-reference#flag--incompatible_strict_action_env.
build --incompatible_strict_action_env

# To pick up, e.g. build:linux. Reference: https://bazel.build/reference/command-line-reference#flag--enable_platform_specific_config.
build --enable_platform_specific_config

#
# The grpc library currently does not compile on a Mac, which makes it hard to run unit tests during development.
#
# The compile error looks like this:
#   ERROR: [...]/external/com_github_grpc_grpc/BUILD:2095:1: Linking of rule '@com_github_grpc_grpc//:grpc++_base' failed (Exit 1) cc_wrapper.sh failed: error executing command external/local_config_cc/cc_wrapper.sh -lc++ -fobjc-link-runtime -Wl,-S -shared -o bazel-out/darwin-fastbuild/bin/external/com_github_grpc_grpc/libgrpc++_base.so ... (remaining 41 argument(s) skipped)
#
# The following workaround was suggested by https://github.com/grpc/grpc/issues/19645
#
build --copt -DGRPC_BAZEL_BUILD
build --cxxopt=-std=c++17

# Enable position independent code (this is the default on macOS and Windows)
# (Workaround for https://github.com/bazelbuild/rules_foreign_cc/issues/421)
build:linux --copt=-fPIC
build:linux --copt=-Wno-deprecated-declarations
build:linux --cxxopt=-std=c++17
build:linux --conlyopt=-fexceptions
build:linux --action_env=BAZEL_LINKLIBS=-l%:libstdc++.a
build:linux --action_env=BAZEL_LINKOPTS=-lm

# We already have absl in the build, define absl=1 to tell googletest to use absl for backtrace.
build --define absl=1

# Pass PATH, CC, CXX and LLVM_CONFIG variables from the environment.
build --action_env=CC
build --action_env=CXX
build --action_env=LLVM_CONFIG
build --action_env=PATH

# Common flags for Clang
build:clang --action_env=BAZEL_COMPILER=clang
build:clang --action_env=CC=clang --action_env=CXX=clang++
build:clang --linkopt=-fuse-ld=lld

# Clang with libc++
build:libc++ --config=clang
build:libc++ --action_env=CXXFLAGS=-stdlib=libc++
build:libc++ --action_env=LDFLAGS=-stdlib=libc++
build:libc++ --action_env=BAZEL_CXXOPTS=-stdlib=libc++
build:libc++ --action_env=BAZEL_LINKLIBS=-l%:libc++.a:-l%:libc++abi.a
build:libc++ --action_env=BAZEL_LINKOPTS=-lm:-pthread
build:libc++ --define force_libcpp=enabled

try-import %workspace%/clang.bazelrc
try-import %workspace%/user.bazelrc
